<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mandelbrot Gigapixel Viewer</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }
    #viewer {
      width: 100vw;
      height: 100vh;
    }
    #coordinate-display {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 5px 10px;
      font-family: monospace;
      font-size: 14px;
      border-radius: 5px;
    }
  </style>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>
</head>
<body>
  <div id="viewer"></div>
  <div id="coordinate-display">Re: -0.75, Im: 0.00</div>

  <script>
    window.onload = function () {
      let tiledImage = null;

      const viewer = OpenSeadragon({
        id: "viewer",
        prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/images/",
        showNavigationControl: true,
        tileSources: {
          height: 32768,
          width: 32768,
          tileSize: 256,
          minLevel: 0,
          maxLevel: 7,
          getTileUrl: function (level, x, y) {
            return `tiles/z${level}/${x}_${y}.jpg`;
          }
        },
        minZoomLevel: 0,
        defaultZoomLevel: 1,
        maxZoomPixelRatio: 4,
        visibilityRatio: 1,
        constrainDuringPan: true
      });

      const coordinateDisplay = document.getElementById('coordinate-display');

      // Add a handler for the 'open' event to ensure the tiledImage is ready.
      viewer.addHandler('open', function () {
        tiledImage = viewer.world.getItemAt(0);
        
        // Final check to see if the image is actually loaded and ready
        if (tiledImage) {
          console.log("Viewer is ready and image is loaded. Coordinate tracker should now be active.");
        } else {
          console.error("Failed to get tiled image. Please check your tile source path and server configuration.");
        }
      });

      // Use a custom event handler on the viewer's canvas to get a robust position.
      // This is a reliable alternative to OpenSeadragon's default 'mouse-move' event.
      viewer.canvas.addEventListener('mousemove', function (e) {
        if (!tiledImage) {
          return;
        }

        // Get mouse position relative to the viewer's canvas
        const rect = viewer.canvas.getBoundingClientRect();
        const webPoint = new OpenSeadragon.Point(e.clientX - rect.left, e.clientY - rect.top);
        
        const viewportPoint = viewer.viewport.pointFromPixel(webPoint);
        const imagePoint = tiledImage.viewportToImageCoordinates(viewportPoint);

        if (!imagePoint) {
          return;
        }

        const complexWidth = 3.0;
        const complexHeight = 3.0;
        const centerRe = -0.75;
        const centerIm = 0.0;
        const imgWidth = tiledImage.source.width;
        const imgHeight = tiledImage.source.height;
        
        const re = centerRe - (complexWidth / 2) + (imagePoint.x / imgWidth) * complexWidth;
        const im = centerIm + (complexHeight / 2) - (imagePoint.y / imgHeight) * complexHeight;

        coordinateDisplay.textContent = `Re: ${re.toFixed(8)}, Im: ${im.toFixed(8)}`;
      });
    };
  </script>
</body>
</html>
